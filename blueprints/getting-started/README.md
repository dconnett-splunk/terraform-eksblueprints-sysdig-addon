# Getting Started Sysdig Terraform Blueprint for EKS

## Introduction

[Sysdig](https://sysdig.com) platform allows you to confidently run containers, Kubernetes, and cloud. 
This [Getting Started](/blueprints) blueprint allows you to deploy an AWS EKS cluster with the [Sysdig](https://sysdig.com) addon incorporated. You will be able to customize and extend the blueprint following a gitops approach to adapt it to your needs regarding to (security)[https://sysdig.com/products/secure/], (monitoring)[https://sysdig.com/products/monitor/] or both secure and monitor with [Sysdig Platform Architecture](https://sysdig.com/platform-architecture/).

The following components willl be generated by this blueprint:

* 1x VPC with private and public subnets
* 1x EKS Cluster
* 1x Managed node group for EKS
* Sysdig instrumentation as Daemonset via Helm on the cluster

## Usage

### Prerequisites

#### Tools

Please make sure that there are the following tools installed  

* [Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli)
* [AWS-Cli](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
* [Kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl)

#### Configuration

1. Clone this repository and get into the blueprint folder

    ````
    git clone https://github.com/sysdiglabs/terraform-eksblueprints-sysdig-addon.git

    cd blueprints/getting-started
    ````

2. Initialize TF VARS with the proper credentials and urls from your Sysdig SaaS account and region.
https://docs.sysdig.com/en/docs/administration/saas-regions-and-ip-ranges   
You can optionally indicate a cluster name and AWS region.

    ```
    export TF_VAR_sysdig_accesskey=<sysdig-agent-accesskey>
    export TF_VAR_sysdig_collector_endpoint=<sysdig_collector_endpoint>
    export TF_VAR_nodeanalyzer-api-endpoint=<sysdig_nodeanalyzer_api_endpoint>
    export TF_VAR_cluster_name=<cluster_name>   # Optional
    export TF_VAR_aws_region=<aws-region>       # Optional
    ```

    Example using a Sysdig account from us-west (us2) monitoring an EKS cluster located in the AWS region of Sao Paolo (sa-east-1)
    ```
    export TF_VAR_sysdig_accesskey=fa3efa3e-95ee-4233-b222-fa3efa3e8120a
    export TF_VAR_sysdig_collector_endpoint=ingest-us2.app.sysdig.com
    export TF_VAR_nodeanalyzer-api-endpoint=us2.app.sysdig.com
    export TF_VAR_cluster_name="my-aws-cluster-sysdig"
    export TF_VAR_aws_region="sa-east-1"
    ```
3. Initialize, plan the execution and then apply

    ```
    terraform init
    terraform plan
    terraform apply
    ```
4. Once the Terraform script finishes process, we can configure our local kubeconfig with the following aws-cli command. (<aws-region> and <cluster-name> has to be copied from the previous output or use $TF_VAR_cluster_name and $TF_VAR_aws_region if they was declared before)
    ```
    aws eks --region <aws-region> update-kubeconfig --name <cluster-name>
    ```
5. Our EKS cluster is ready to be operated, we can check the runnning pods
    ```
    kubectl get nodes --all-namespaces
    ```